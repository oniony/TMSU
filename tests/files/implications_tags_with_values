#!/usr/bin/env bash

# setup

add_file 1 '/file1'
add_file 2 '/file2'
add_file 3 '/file3'
add_file 4 '/file4'
add_file 5 '/file5'
add_file 6 '/file6'
add_tag 1 'j'
add_tag 2 'k'
add_tag 3 'l'
add_tag 4 'x'
add_tag 5 'y'
add_tag 6 'z'
add_value 1 '1'
add_value 2 '2'
add_value 3 '3'
add_implication 1 1 2 0 # j=1 -> k
add_implication 2 0 3 0 # k -> l
add_implication 4 0 5 2 # x -> y=2
add_implication 5 0 6 0 # y -> z
add_file_tag 1 1 1 		# /file1 j=1 (k l)
add_file_tag 2 2 2 		# /file2 k=2 (l)
add_file_tag 3 3 0 		# /file3 l
add_file_tag 4 4 1 		# /file4 x=1 (y=2 z)
add_file_tag 5 5 3 		# /file5 y=3 (z)
add_file_tag 6 6 0      # /file6 z

# test

echo -1-                                >>$OUT
tmsu files j=1                          >>$OUT 2>>$ERR
echo -2-                                >>$OUT
tmsu files k                            >>$OUT 2>>$ERR
echo -3-                                >>$OUT
tmsu files l                            >>$OUT 2>>$ERR
echo -4-                                >>$OUT
tmsu files --explicit j=1               >>$OUT 2>>$ERR
echo -5-                                >>$OUT
tmsu files --explicit k                 >>$OUT 2>>$ERR
echo -6-                                >>$OUT
tmsu files --explicit l                 >>$OUT 2>>$ERR
echo -7-                                >>$OUT
tmsu files x                            >>$OUT 2>>$ERR
echo -8-                                >>$OUT
tmsu files y=2                          >>$OUT 2>>$ERR
echo -9-                                >>$OUT
tmsu files z                            >>$OUT 2>>$ERR
echo -10-                               >>$OUT
tmsu files --explicit x                 >>$OUT 2>>$ERR
echo -11-                               >>$OUT
tmsu files --explicit y=2               >>$OUT 2>>$ERR
echo -12-                               >>$OUT
tmsu files --explicit z                 >>$OUT 2>>$ERR

# verify

diff - <<EOF $ERR
EOF
if [[ $? -ne 0 ]]; then
    exit 1
fi

diff - <<EOF $OUT
-1-
/file1
-2-
/file1
/file2
-3-
/file1
/file2
/file3
-4-
/file1
-5-
/file2
-6-
/file3
-7-
/file4
-8-
/file4
-9-
/file4
/file5
/file6
-10-
/file4
-11-
-12-
/file6
EOF
if [[ $? -ne 0 ]]; then
    exit 1
fi
